# Design Document: V10.0 - The Complete Native Experience

## Overview

V10.0 delivers three major improvements to Specialize:

1. **PWA Infrastructure**: Home screen installation with proper manifest, icons, and service worker
2. **UI Polish**: Upgraded Button/Card components, mobile navigation, and empty states
3. **Google Auth**: One-click sign-in via Supabase OAuth

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Next.js App                            │
├─────────────────────────────────────────────────────────────┤
│  Layout (RootLayout)                                        │
│  ├── PWA Meta Tags (manifest, apple-touch-icon, theme)      │
│  ├── InstallBanner (conditional on browser mode)            │
│  └── App Shell                                              │
│       ├── Sidebar (desktop only, hidden on mobile)          │
│       ├── MobileNavBar (mobile only, fixed bottom)          │
│       └── Page Content                                      │
├─────────────────────────────────────────────────────────────┤
│  Auth Flow                                                  │
│  ├── LoginPage (Google OAuth button + logo)                 │
│  └── Supabase Auth (handles OAuth redirect)                 │
├─────────────────────────────────────────────────────────────┤
│  Service Worker (generated by next-pwa)                     │
│  └── Static asset caching                                   │
└─────────────────────────────────────────────────────────────┘
```

## Components and Interfaces

### 1. PWA Configuration

**File: `next.config.ts`**
```typescript
import withPWA from 'next-pwa';

const config = withPWA({
  dest: 'public',
  disable: process.env.NODE_ENV === 'development',
  register: true,
  skipWaiting: true,
  buildExcludes: [/middleware-manifest\.json$/], // CRITICAL: Prevents Vercel crash
})({
  // existing Next.js config
});

export default config;
```

**File: `public/manifest.json`**
```json
{
  "name": "Specialize",
  "short_name": "Specialize",
  "description": "Medical exam preparation with spaced repetition",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#ffffff",
  "orientation": "portrait",
  "icons": [
    { "src": "/icon-192x192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icon-512x512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

### 2. InstallBanner Component

**File: `src/components/pwa/InstallBanner.tsx`**

```typescript
interface InstallBannerProps {
  className?: string;
}

// Internal state
interface BannerState {
  isVisible: boolean;
  isStandalone: boolean;
  isIOS: boolean;
  isDismissed: boolean;
}
```

**Visibility Logic:**
```typescript
const shouldShow = !isStandalone && !isDismissed;
```

**Platform Detection:**
```typescript
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
```

**LocalStorage Key:** `specialize-install-banner-dismissed`

### 3. Button Component Upgrade

**File: `src/components/ui/Button.tsx`**

```typescript
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'ghost' | 'destructive';
  size?: 'sm' | 'md' | 'lg';
  loading?: boolean;
  children: React.ReactNode;
}
```

**Variant Styles:**
| Variant | Background | Text | Border |
|---------|------------|------|--------|
| primary | bg-blue-600 | text-white | none |
| secondary | bg-slate-100 | text-slate-900 | border-slate-200 |
| ghost | transparent | text-slate-600 | none |
| destructive | bg-red-600 | text-white | none |

**Loading State:**
- Disable button (`disabled={true}`)
- Show spinner icon (Loader2 from lucide-react with `animate-spin`)
- Maintain button width to prevent layout shift

### 4. Card Component Upgrade

**File: `src/components/ui/Card.tsx`**

```typescript
interface CardProps {
  children: React.ReactNode;
  className?: string;
}
```

**Required Styles:**
```typescript
const baseStyles = 'rounded-xl border border-slate-200 shadow-sm bg-white';
```

### 5. Empty State Component

**File: `src/components/ui/EmptyState.tsx`**

```typescript
interface EmptyStateProps {
  icon?: React.ReactNode;
  title: string;
  description?: string;
  action?: React.ReactNode;
}
```

**Usage Example:**
```tsx
<EmptyState
  icon={<BookOpen className="h-12 w-12 text-slate-400" />}
  title="No decks yet"
  description="Create your first deck to start studying"
  action={<Button>Create Deck</Button>}
/>
```

### 6. MobileNavBar Component

**File: `src/components/navigation/MobileNavBar.tsx`**

```typescript
interface NavItem {
  href: string;
  icon: React.ReactNode;
  label: string;
}

const navItems: NavItem[] = [
  { href: '/dashboard', icon: <Home />, label: 'Home' },
  { href: '/library', icon: <Library />, label: 'Library' },
  { href: '/profile', icon: <User />, label: 'Profile' },
];
```

**Styles:**
- Fixed to bottom: `fixed bottom-0 left-0 right-0`
- Safe area padding: `pb-safe` (for iOS notch)
- Background: `bg-white border-t border-slate-200`
- Active item: `text-blue-600` vs inactive `text-slate-500`

**Responsive Logic:**
- Show on mobile: `md:hidden`
- Hide sidebar on mobile: sidebar gets `hidden md:flex`

### 7. Google Auth Integration

**File: `src/app/(auth)/login/page.tsx`**

```typescript
async function handleGoogleSignIn() {
  const supabase = createSupabaseBrowserClient();
  
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`,
    },
  });
  
  if (error) {
    setError(error.message);
  }
}
```

**Auth Callback Route:** `src/app/auth/callback/route.ts`
- Exchanges code for session
- Redirects to `/dashboard` on success

## Data Models

No database changes required. This feature is purely frontend + auth configuration.

**LocalStorage Keys:**
- `specialize-install-banner-dismissed`: `"true"` | `undefined`

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Install Banner Visibility Logic
*For any* combination of (isStandalone, isDismissed) states, the InstallBanner should be visible if and only if `!isStandalone && !isDismissed`.
**Validates: Requirements 2.1, 2.2, 2.3**

### Property 2: Install Banner Dismissal Persistence
*For any* dismissal action on the InstallBanner, the localStorage key should be set to "true" and subsequent visibility checks should return false.
**Validates: Requirements 2.3**

### Property 3: iOS Platform Detection
*For any* user agent string containing "iPad", "iPhone", or "iPod", the InstallBanner should display iOS-specific instructions.
**Validates: Requirements 2.4**

### Property 4: Button Primary Variant Styling
*For any* Button rendered with variant="primary", the component should include blue background color classes.
**Validates: Requirements 3.1**

### Property 5: Button Secondary Variant Styling
*For any* Button rendered with variant="secondary", the component should include slate color classes.
**Validates: Requirements 3.2**

### Property 6: Button Loading State
*For any* Button rendered with loading=true, the button should be disabled and contain a spinner element.
**Validates: Requirements 3.3**

### Property 7: Card Base Styling
*For any* Card component rendered, the output should include rounded-xl, border-slate-200, and shadow-sm classes.
**Validates: Requirements 3.4**

### Property 8: MobileNavBar Items
*For any* rendered MobileNavBar, it should contain exactly three navigation items: Home, Library, and Profile.
**Validates: Requirements 4.3**

### Property 9: MobileNavBar Active State
*For any* navigation item where the href matches the current pathname, the item should have active styling (blue color).
**Validates: Requirements 4.4**

### Property 10: MobileNavBar Navigation
*For any* click on a navigation item, the router should navigate to the item's href.
**Validates: Requirements 4.5**

## Error Handling

| Scenario | Handling |
|----------|----------|
| Service worker registration fails | Silent fail; app works without caching |
| Google OAuth fails | Display error message on login page |
| localStorage unavailable | Banner shows every session (graceful degradation) |
| Network error during OAuth | Show "Connection error, please try again" |

## Testing Strategy

### Property-Based Testing (fast-check)

Properties to test with fast-check:
1. **Banner Visibility**: Generate all combinations of (isStandalone, isDismissed), verify visibility formula
2. **Platform Detection**: Generate various user agent strings, verify iOS detection
3. **Button Variants**: Generate all variant values, verify correct class application
4. **NavBar Active State**: Generate various pathname/href combinations, verify active detection

### Unit Tests

- Manifest JSON structure validation
- Button variant class mapping
- Card base styles presence
- MobileNavBar item rendering
- Google OAuth button click handler

### Integration Tests

- Auth callback redirect flow
- Banner dismissal persistence across page loads

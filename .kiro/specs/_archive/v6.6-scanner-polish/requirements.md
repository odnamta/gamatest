# Requirements Document

## Introduction

V6.6 "Scanner Polish" addresses concrete friction points discovered during field testing of the Bulk Import pipeline. The focus is on fixing page breaks (questions spanning multiple pages), Vision ignoring images, missing Option E support, and inconsistent tagging—without changing core workflows.

**Invariants:**
- ENGINE: Keep V2 Shared Library as the only study engine (no new flags)
- DATA: Do not change existing SRS fields or units/numbers in cards
- UX: Keep the current Bulk Import layout (Scan Page + Batch Review) intact; only refine it
- VISION: Client-side resize (~1024px max dimension) remains mandatory

## Glossary

- **BulkImportPage**: The main page component at `/decks/[deckId]/add-bulk` for PDF-assisted MCQ creation
- **Context Stitcher**: Feature allowing users to combine text from adjacent PDF pages before AI processing
- **TextSelectionToolbar**: Component providing buttons to copy selected text to MCQ form fields
- **BatchReviewPanel**: Modal component for reviewing and editing multiple AI-generated MCQ drafts
- **BatchDraftCard**: Individual card component within BatchReviewPanel for editing a single draft
- **TagSelector**: Reusable component for selecting and managing tags with autocomplete
- **AI Mode**: Toggle between "extract" (verbatim from Q&A) and "generate" (create from textbook)
- **Session Tags**: Tags applied to all cards created during a bulk import session
- **AI Tags**: Tags automatically generated by the AI for individual cards (purple styling)

## Requirements

### Requirement 1: Context Stitcher - Append Next Page

**User Story:** As a user importing MCQs from PDFs, I want to append text from the next page to my current text area, so that I can handle questions that span page breaks.

#### Acceptance Criteria

1. WHEN the user clicks the "Append Next Page" button in BulkImportPage THEN THE System SHALL extract text from `currentPage + 1` using the existing `extractCleanPageText` utility
2. WHEN text is extracted from the next page THEN THE System SHALL append it to the PDF Text Reference textarea with a clear separator format: `\n\n--- Page X ---\n`
3. WHEN the append operation completes THEN THE System SHALL update local state so the user can hand-edit the stitched text before running AI Draft or Batch Draft
4. IF the current page is the last page of the PDF THEN THE System SHALL disable the "Append Next Page" button and display a tooltip "Already on last page"
5. WHEN the append button is clicked THEN THE System SHALL show a loading indicator during text extraction

### Requirement 2: Context Stitcher - Scan Page +1 Mode

**User Story:** As a user, I want to optionally include the next page when scanning, so that I can extract questions spanning two pages with one click.

#### Acceptance Criteria

1. WHEN the BulkImportPage renders with a linked PDF THEN THE System SHALL display an "Include Next Page" checkbox near the Scan Page button
2. WHEN the checkbox is checked AND the user clicks "Scan Page" THEN THE System SHALL pass text from both `currentPage` and `currentPage + 1` into the batch draft pipeline
3. WHEN combining two pages for scanning THEN THE System SHALL concatenate the text with a `\n\n--- Page X ---\n` separator between pages
4. IF the current page is the last page THEN THE System SHALL disable the checkbox and display a tooltip "No next page available"
5. WHEN the checkbox state changes THEN THE System SHALL persist the preference in local state for the current session

### Requirement 3: Vision Priority and UX Improvements

**User Story:** As a user adding images to my MCQ drafts, I want the AI to prioritize the image content over background text, so that image-based questions are extracted correctly.

#### Acceptance Criteria

1. WHEN an image is provided via "Add Image" THEN THE System SHALL update the Vision system prompt to: "IF an image is provided, treat it as primary. The text may just be background. Prefer questions that clearly come from the image. If NO question is visible, say so instead of inventing one."
2. WHEN an image is attached from "Add Image" THEN THE System SHALL log the presence and size of `imageBase64` or `imageUrl` for debugging purposes
3. WHEN the BulkImportPage renders THEN THE System SHALL display helper text under "Add Image (optional)": "Use this when the question or diagram is an IMAGE (e.g. CT, ultrasound, graph). It is not for embedding images into the card."

### Requirement 4: Option E Support in TextSelectionToolbar

**User Story:** As a user creating MCQs with 5 options, I want a "To Option E" button in the toolbar, so that I can quickly copy text to the fifth option.

#### Acceptance Criteria

1. WHEN the TextSelectionToolbar renders THEN THE System SHALL display a "To Option E" button that mirrors the behavior of the A–D buttons
2. WHEN the user clicks "To Option E" with text selected THEN THE System SHALL copy the selected text to the fifth option field (index 4)
3. WHEN the user clicks "To Option E" with no text selected THEN THE System SHALL display the same "Select text in the left box first." warning as other buttons
4. WHEN the field sequence is used for auto-focus navigation THEN THE System SHALL include optionE between optionD and explanation

### Requirement 5: AI Batch Draft Warning Consistency

**User Story:** As a user, I want consistent warning messages across all AI draft buttons, so that I understand when text selection is required.

#### Acceptance Criteria

1. WHEN the user clicks "AI Batch Draft" button with no text selected THEN THE System SHALL display the warning "Select text in the left box first."
2. WHEN the user clicks "AI Draft" button with no text selected THEN THE System SHALL display the same warning message for consistency

### Requirement 6: AI Mode Semantics Enforcement

**User Story:** As a user, I want the AI to strictly follow extract vs generate mode semantics, so that extract mode only extracts existing MCQs without inventing content.

#### Acceptance Criteria

1. WHEN mode equals "extract" THEN THE System SHALL instruct the AI model to ONLY extract existing MCQs from the source text
2. WHEN mode equals "generate" THEN THE System SHALL instruct the AI model that it can create new MCQs from the content
3. WHEN mode equals "extract" THEN THE System SHALL ensure the number of options in the output does not exceed what was detected in the source text

### Requirement 7: Single Draft Tag Parity

**User Story:** As a user creating single MCQ drafts, I want AI-generated tags to appear in the form, so that single drafts have the same tagging experience as batch drafts.

#### Acceptance Criteria

1. WHEN `draftMCQFromText` returns a successful draft THEN THE System SHALL include a `tags: string[]` field using the same tag-generation helper as Batch/Scan Page
2. WHEN the AI populates the CreateMCQForm (BulkMCQForm) THEN THE System SHALL pre-fill the TagSelector with AI tags displayed in purple styling
3. WHEN session tags exist AND AI tags are returned THEN THE System SHALL merge them without duplication using case-insensitive comparison
4. WHEN the mcqDraftSchema validates AI response THEN THE System SHALL accept an optional `tags` array field

### Requirement 8: Editable Tags in Batch Review

**User Story:** As a user reviewing batch drafts, I want to edit the tags for each card, so that I can correct bad AI tags and add relevant ones before saving.

#### Acceptance Criteria

1. WHEN the BatchReviewPanel displays draft cards THEN THE System SHALL render a TagSelector instance for each draft card instead of read-only tag chips
2. WHEN the user deletes an AI tag from a draft card THEN THE System SHALL update that card's tag list immediately
3. WHEN the user adds a new tag to a draft card THEN THE System SHALL include it in the final saved card's tag list
4. WHEN the user edits tags on one card THEN THE System SHALL NOT re-mount the entire draft list (key by draft id for performance)
5. WHEN the batch is saved THEN THE System SHALL honour the edited tag list for each card


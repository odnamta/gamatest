# Design Document: V3.2 Visual Polish & Bug Fixes

## Overview

V3.2 addresses visual polish and bug fixes in three areas:

1. **GitHub-Style Heatmap** - Right-aligned grid layout with 28 days (mobile) or 84 days (desktop), today always at bottom-right
2. **Dashboard Cleanup** - Hide incomplete course features, remove floating deck button
3. **Bulk Import Usability** - Permanent SourceBar with replace functionality, power-user copy toolbar with Option D support

## Architecture

Changes are localized to existing components:

```
src/
├── components/
│   ├── dashboard/
│   │   ├── StudyHeatmap.tsx      # GitHub-style right-aligned grid
│   │   └── LibrarySection.tsx    # Hide courses completely
│   └── cards/
│       ├── SourceBar.tsx         # Add Replace button state
│       ├── TextSelectionToolbar.tsx # Add Option D button
│       └── CreateMCQForm.tsx     # Support 5 options (A-E)
├── lib/
│   └── use-responsive-day-count.ts # Update to 28/84 days
└── app/(app)/decks/[deckId]/add-bulk/page.tsx # Integrate changes
```

## Components and Interfaces

### 1. StudyHeatmap (Refactored)

```typescript
// Grid configuration for GitHub-style layout
const DAYS_PER_ROW = 7  // Always 7 columns (one week)
const MOBILE_ROWS = 4   // 4 weeks = 28 days
const DESKTOP_ROWS = 12 // 12 weeks = 84 days

// Layout: right-aligned, bottom-right is today
// Grid fills from top-left, so we need to calculate start position
```

**Key Changes:**
- Use `justify-end` for right alignment
- 28 days (4x7) on mobile, 84 days (12x7) on desktop
- Today is always the last cell (bottom-right)
- Squares with gaps matching GitHub style

### 2. LibrarySection (Simplified)

```typescript
// Comment out ALL courses-related code
// Only render Decks section
```

**Key Changes:**
- Remove/comment out courses rendering
- Remove Create Course button
- Only show Decks section

### 3. SourceBar (Enhanced)

```typescript
interface SourceBarProps {
  linkedSource: { fileName: string; fileUrl?: string } | null
  onUploadClick: () => void
  onReplaceClick: () => void
}
```

**States:**
- No file: Show "Upload PDF" button
- File linked: Show filename (green) + "Replace" button

### 4. TextSelectionToolbar (Extended)

```typescript
type TargetField = 'stem' | 'optionA' | 'optionB' | 'optionC' | 'optionD' | 'explanation'

const FIELD_SEQUENCE: TargetField[] = ['stem', 'optionA', 'optionB', 'optionC', 'optionD', 'explanation']
```

**Buttons:**
- To Stem
- To Option A, B, C, D
- To Explanation

### 5. CreateMCQForm (Extended)

```typescript
const MIN_OPTIONS = 2
const MAX_OPTIONS = 5  // A-E for medical exams
```

## Data Models

No database changes. UI-only modifications.

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Heatmap Day Count by Viewport

*For any* viewport width, the heatmap SHALL display exactly 28 days (4 rows × 7 columns) when width is below the large breakpoint, and exactly 84 days (12 rows × 7 columns) when width is at or above the large breakpoint.

**Validates: Requirements 1.2, 1.3**

### Property 2: Heatmap Day Ordering (Today at End)

*For any* array of study days generated by the heatmap, the last element SHALL always be today's date, ensuring today appears at the bottom-right of the grid.

**Validates: Requirements 1.4**

### Property 3: Text Selection Transfer

*For any* text selection in the source textarea (where selectionStart < selectionEnd), clicking a copy-to-field button SHALL transfer exactly the substring from selectionStart to selectionEnd into the corresponding target field.

**Validates: Requirements 5.2**

### Property 4: Focus Sequencing After Paste

*For any* target field in the sequence [stem, optionA, optionB, optionC, optionD, explanation], after pasting text into that field, focus SHALL move to the next field in the sequence.

**Validates: Requirements 5.3**

### Property 5: Option Array Labeling Invariant

*For any* sequence of add and remove operations on the options array (with max 5 options), the resulting options SHALL always be labeled sequentially as A, B, C, D, E corresponding to indices 0-4 with no gaps or duplicates.

**Validates: Requirements 6.2, 6.3**

## Error Handling

| Scenario | Handling |
|----------|----------|
| No text selected when copy button clicked | Show toast: "Select text first" |
| Attempt to add option when at max (5) | Hide add button |
| Attempt to remove option when at min (2) | Hide remove button |
| Replace button clicked | Reset to upload state |

## Testing Strategy

### Property-Based Testing

Using **Vitest** with **fast-check** (existing setup).

Each property test will:
- Run minimum 100 iterations
- Be tagged with format: `**Feature: v3.2-visual-polish, Property {number}: {property_text}**`

### Test Files

```
src/__tests__/
├── heatmap-responsive.property.test.ts  # Update for 28/84 days
├── text-selection-toolbar.property.test.ts # Add Option D
└── mcq-options.property.test.ts         # Update max to 5
```

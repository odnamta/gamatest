# Implementation Plan

- [x] 1. Create Global Study Server Actions and Core Logic
  - [x] 1.1 Create global due count computation logic
    - Create `src/lib/global-due-count.ts` with pure function `computeGlobalDueCount(cards: { next_review: string }[], now: string): number`
    - Function counts cards where `next_review <= now`
    - _Requirements: 1.2_
  - [x] 1.2 Write property test for global due count
    - **Property 1: Global due count accuracy**
    - **Validates: Requirements 1.2**
  - [x] 1.3 Create daily progress computation logic
    - Create `src/lib/daily-progress.ts` with pure function `computeDailyProgress(studyLog: { cards_reviewed: number } | null): number`
    - Returns `cards_reviewed` or 0 if no log exists
    - _Requirements: 1.3, 1.4_
  - [x] 1.4 Write property test for daily progress
    - **Property 2: Daily progress calculation**
    - **Validates: Requirements 1.3, 1.4**
  - [x] 1.5 Create global study server actions
    - Create `src/actions/global-study-actions.ts`
    - Implement `getGlobalDueCards(batchNumber?: number)`: fetch due cards across all decks, ordered by `next_review` ASC, limit 50 per batch
    - Implement `getGlobalStats()`: return `totalDueCount`, `completedToday`, `currentStreak`, `hasNewCards`
    - Implement fallback: if 0 due cards, fetch up to 10 new cards instead
    - Return `hasMoreBatches` boolean for pagination
    - _Requirements: 2.2, 2.3, 2.4_
  - [x] 1.6 Write property test for global cards ordering
    - **Property 3: Global due cards ordering and limit**
    - **Validates: Requirements 2.2**
  - [x] 1.7 Write property test for new cards fallback
    - **Property 4: New cards fallback**
    - **Validates: Requirements 2.4**

- [x] 2. Checkpoint
  - Ensure all tests pass, ask the user if questions arise.

- [x] 3. Build Dashboard Hero Component
  - [x] 3.1 Create DashboardHero component
    - Create `src/components/dashboard/DashboardHero.tsx`
    - Display greeting "Hi Celline üëã Ready to study?"
    - Show global due count, completed today count
    - Display streak badge "üî• X-day streak" from user_stats
    - Daily goal progress as circular ring/progress bar/X/Y format (green when complete)
    - Large "Start Today's Session" button linking to `/study/global`
    - Show "Resume Session" button if unfinished session exists in localStorage
    - Empty state message when no due cards and no new cards
    - Mobile-first: button spans full width on mobile
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 7.2_

- [x] 4. Build Library Section Component
  - [x] 4.1 Create LibrarySection component
    - Create `src/components/dashboard/LibrarySection.tsx`
    - Collapsible section with label "Library & Content"
    - Contains courses and decks listings
    - Include "Add Deck" button within section
    - Default to collapsed state
    - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 5. Update Dashboard Page
  - [x] 5.1 Integrate DashboardHero into dashboard
    - Modify `src/app/(app)/dashboard/page.tsx`
    - Add DashboardHero as first element (above everything else)
    - Fetch global stats using `getGlobalStats()`
    - Check localStorage for unfinished session state
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 3.5_
  - [x] 5.2 Integrate LibrarySection into dashboard
    - Wrap existing courses and decks sections in LibrarySection component
    - Remove duplicate section headers (now handled by LibrarySection)
    - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 6. Checkpoint
  - Ensure all tests pass, ask the user if questions arise.

- [x] 7. Build Global Study Session Components
  - [x] 7.1 Create session state management utilities
    - Create `src/lib/session-state.ts` with functions:
      - `saveSessionState(state: CachedSessionState): void` - save to localStorage
      - `getSessionState(): CachedSessionState | null` - retrieve from localStorage
      - `clearSessionState(): void` - clear localStorage
      - `isSessionStale(state: CachedSessionState): boolean` - check if older than 24 hours
    - _Requirements: 1.8_
  - [x] 7.2 Create GlobalStudySummary component
    - Create `src/components/study/GlobalStudySummary.tsx`
    - Display correct count, incorrect count, streak progress
    - Large "Return to Dashboard" button
    - Conditional "Continue Studying" button when `remainingDueCount > 0`
    - Mobile-first: 44px minimum tap targets
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 7.4_
  - [x] 7.3 Write property test for session summary state
    - **Property 5: Session summary state consistency**
    - **Validates: Requirements 2.6, 6.1**
  - [x] 7.4 Write property test for continue button display
    - **Property 7: Continue button conditional display**
    - **Validates: Requirements 6.3, 6.4**
  - [x] 7.5 Create GlobalStudySession component
    - Create `src/components/study/GlobalStudySession.tsx`
    - Track session state: currentIndex, correctCount, incorrectCount, isComplete
    - Render MCQQuestion for MCQ cards, Flashcard for regular cards
    - Handle card type detection and appropriate component rendering
    - Persist state to localStorage on each answer for resume capability
    - Clear localStorage cache on session completion
    - Show GlobalStudySummary when session complete
    - Trigger toast "Great work today!" on completion
    - _Requirements: 2.5, 2.6, 2.7_

- [x] 8. Create Global Study Route
  - [x] 8.1 Create global study page
    - Create `src/app/(app)/study/global/page.tsx`
    - Server component that calls `getGlobalDueCards(batchNumber)`
    - Accept optional `batch` query parameter for pagination
    - Pass cards and `totalDueRemaining` to GlobalStudySession client component
    - Handle empty state (redirect to dashboard with message)
    - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 9. Checkpoint
  - Ensure all tests pass, ask the user if questions arise.

- [x] 10. Enhance Bulk Import Page
  - [x] 10.1 Create BulkImportStepper component
    - Create `src/components/cards/BulkImportStepper.tsx`
    - Display breadcrumb: "1. Upload PDF ‚Üí 2. Select Text ‚Üí 3. Create MCQ"
    - Green banner showing "üìñ Linked Source: {filename}.pdf" when source linked
    - Make filename a clickable link that opens Supabase public URL in new tab
    - Hide banner when no source linked
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  - [x] 10.2 Create TextToStemButton component
    - Create `src/components/cards/TextToStemButton.tsx`
    - Button labeled "‚¨áÔ∏è Copy selected text to Question Stem"
    - Read selection from textarea ref
    - Call `onTextSelected` callback with selected text
    - Show toast "Select text in the left box first." when no selection
    - _Requirements: 5.1, 5.2, 5.3_
  - [x] 10.3 Write property test for text selection transfer
    - **Property 6: Text selection transfer**
    - **Validates: Requirements 5.2**
  - [x] 10.4 Create AI Draft placeholder
    - Add disabled button "‚ú® AI Draft (Coming Soon)" with tooltip "Coming soon" to bulk import page
    - Create placeholder `draftMCQFromText()` server action in `src/actions/global-study-actions.ts`
    - Return predictable dummy MCQ: `{ stem: "AI Draft Placeholder", options: ["A", "B", "C", "D"], correct_index: 0, explanation: "AI explanation placeholder." }`
    - Ensure button does NOT invoke server action automatically when disabled
    - _Requirements: 5.4, 5.5, 5.6_
  - [x] 10.5 Update bulk import page with new components
    - Modify `src/app/(app)/decks/[deckId]/add-bulk/page.tsx`
    - Add BulkImportStepper above PDF upload section
    - Add TextToStemButton and AI Draft button between text area and form
    - Wire up text selection to populate CreateMCQForm question stem
    - Mobile-first: remove side-by-side layout on small screens, stack vertically (PDF textarea full width ‚Üí copy button ‚Üí MCQ form)
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 7.3_

- [x] 11. Final Integration and Polish
  - [x] 11.1 Add toast notification system
    - Ensure toast component exists or create simple toast for "Great work today!" and error messages
    - Wire up toast triggers in GlobalStudySession and TextToStemButton
    - _Requirements: 2.7, 5.3_

- [x] 12. Final Checkpoint
  - Ensure all tests pass, ask the user if questions arise.
